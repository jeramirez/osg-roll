<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	The OSG Roll.
	</description>

	<copyright>
         No yet Eduardo's test	
	</copyright>

<changelog>
	$Log: osg-gums.xml,v $
	Revision 0.0  2012/10/05 05:48:53  eduardo
	Initial Revision
	
</changelog>

<package>libxml2.&arch;</package>
<package>yum-priorities</package>
<package>yum-cron</package>
<package>ktune</package>
<package>perl-libwww-perl</package>
<package>perl-URI</package>
<package>fetch-crl3</package>


<post>
<!-- 
     this xml should be called after yum.xml
     yum.xml requires libxml2.&arch; for VMs
-->
#tomcat:x:91:91:Tomcat:/usr/share/tomcat5:/bin/sh
/usr/sbin/groupadd -g 91 tomcat
/usr/sbin/useradd -u 91 -g 91 -c "Tomcat" -s /bin/sh -d /usr/share/tomcat5 tomcat
#mysql:x:27:27:MySQL Server:/usr/lib/mysql:/bin/bash
/usr/sbin/groupadd -g 27 mysql
/usr/sbin/useradd -u 27 -g 27 -c "MySQL Server" -s /bin/bash -d /usr/lib/mysql mysql

 <!-- install osg-gums from local mirror-->
yum install osg-gums  &gt;&gt; /root/yum-install.log 2&gt;&amp;1
/var/lib/trustmanager-tomcat/configure.sh &gt;&gt; /root/yum-install.log 2&gt;&amp;1

 <!-- customize firewall rules for gums-server  -->
<eval mode="xml">
/opt/rocks/bin/rocks add firewall host=&hostname; rulename=A20-GUMS-TCP-PORT network=public service=8443 protocol="tcp" action="ACCEPT" chain="INPUT" flags="-m state --state NEW"
/opt/rocks/bin/rocks report host firewall &hostname;
</eval>


 <!-- create dir for tomcat/gums cert  -->
[ ! -d /etc/grid-security/http ] &amp;&amp; mkdir /etc/grid-security/http
chown tomcat:tomcat /etc/grid-security/http

<file name="/root/install_gums_cert.sh" perms="0750" >
#!/bin/sh

THISHOST=`hostname`
THISEXEC=$0
DIRNAME=`dirname $THISEXEC`
GUMSSERVER="&OSG_GumsServer;"
CERTSDIR="&OSG_StoredCertsDir;/&hostname;"

#temporary solution (or permanent?) while figuring out
#how to import certs at installation step in a secure way
if [ ! -f $DIRNAME/hostcert.pem ]; then
  cp -p $CERTSDIR/hostcert.pem $DIRNAME/.
fi
if [ ! -f $DIRNAME/hostkey.pem ]; then
  cp -p $CERTSDIR/hostkey.pem  $DIRNAME/.
fi
if [ ! -f $DIRNAME/httpcert.pem ]; then
  cp -p $CERTSDIR/httpcert.pem $DIRNAME/.
fi
if [ ! -f $DIRNAME/httpkey.pem ]; then
  cp -p $CERTSDIR/httpkey.pem  $DIRNAME/.
fi

if [ "$THISHOST" == "$GUMSSERVER" ]; then
  echo "installing grid certs on $THISHOST"
  echo "searching certs in $DIRNAME"
  cp -p $DIRNAME/hostcert.pem /etc/grid-security/.
  cp -p $DIRNAME/hostkey.pem /etc/grid-security/.
  chown root:root /etc/grid-security/hostcert.pem
  chown root:root /etc/grid-security/hostkey.pem
  chmod 444 /etc/grid-security/hostcert.pem
  chmod 400 /etc/grid-security/hostkey.pem
  cp -p $DIRNAME/httpcert.pem /etc/grid-security/http/httpcert.pem
  cp -p $DIRNAME/httpkey.pem /etc/grid-security/http/httpkey.pem
  chown -R tomcat:tomcat /etc/grid-security/http
  chmod 444 /etc/grid-security/http/httpcert.pem
  chmod 400 /etc/grid-security/http/httpkey.pem
else
  echo "$THISHOST Wrong server to install "
fi

</file>
<file name="/root/ConfigureGumsUpgradeFromPacman.sh" perms="0700" >
#!/bin/bash

#input parameters
TABLEFROMPACMAN=&OSG_GUMSBackupDir;/gums_1_3.sql
GUMSCONFIGPACMAN=&OSG_GUMSBackupDir;/gums.config_pacman
ADMINID1='&OSG_GUMSDNADMIN;'

#optional input parameters (default recycle old gums passwd and replace gum.config)
GUMSPASSWD=`grep hibernate.connection.password= $GUMSCONFIGPACMAN | sed -e "s@\t\t\thibernate.connection.password='@@" | sed -e "s@'/&gt;@@"`
GUMSCONFIGRPM=/etc/gums/gums.config

#import database from pacman
service mysqld start
echo '1....importing database from pacman'
echo 'CREATE DATABASE IF NOT EXISTS GUMS_1_3;' | mysql
mysql GUMS_1_3 &lt; $TABLEFROMPACMAN
echo 'RENAME TABLE USER TO USERS;' | mysql GUMS_1_3

#set mysql for user gums (configure gums)
echo '2....configuring new gums server'
echo "GRANT ALL ON GUMS_1_3.* TO 'gums'@'localhost' IDENTIFIED BY '$GUMSPASSWD';" | mysql -u root mysql

#get gums.config from pacman and convert it to rpm style (if needed make sure username is gums)
echo '3....converting gums.config from pacman to rpm'
cp -f -p $GUMSCONFIGRPM $GUMSCONFIGRPM.original
cp -f $GUMSCONFIGPACMAN $GUMSCONFIGRPM
chown tomcat:tomcat $GUMSCONFIGRPM
chmod 600 $GUMSCONFIGRPM
sed -i -e "s@hibernate.connection.username='.*'@hibernate.connection.username='gums'@g" $GUMSCONFIGRPM
sed -i -e "s@hibernate.connection.url='jdbc:mysql://.*/GUMS_1_3'@hibernate.connection.url='jdbc:mysql://localhost:3306/GUMS_1_3'@g" $GUMSCONFIGRPM
sed -i -e "s@sslCAFiles=''@sslCAFiles='/etc/grid-security/certificates/*.0'@g" $GUMSCONFIGRPM
sed -i -e "s@/services/VOMSAdmin'@'@g" $GUMSCONFIGRPM

#set add DN admin for gums
echo '4....adding gums DN admin'
cat /usr/lib/gums/sql/addAdmin.mysql | sed -e "s%@ADMINDN@%$ADMINID1%g" | mysql -u gums --password=$GUMSPASSWD

echo "it is recomended to run /usr/bin/mysql_secure_installation"

</file>

<file name="/root/ConfigureGumsUpgradeFromRPM.sh" perms="0700" >
#!/bin/bash

#input parameters
TABLEFROMRPM=&OSG_GUMSBackupDir;/gums_1_3.sql_rpm
GUMSCONFIGFROMRPM=&OSG_GUMSBackupDir;/gums.config_rpm
ADMINID1='&OSG_GUMSDNADMIN;'

#optional input parameters (default recycle old gums passwd and replace gum.config)
GUMSPASSWD=`grep hibernate.connection.password= $GUMSCONFIGFROMRPM | sed -e "s@\t\t\thibernate.connection.password='@@" | sed -e "s@'/&gt;@@"`
GUMSCONFIGRPM=/etc/gums/gums.config

#import database from rpm
service mysqld start
echo '1....importing database from rpm'
echo 'CREATE DATABASE IF NOT EXISTS GUMS_1_3;' | mysql
mysql GUMS_1_3 &lt; $TABLEFROMRPM

#set mysql for user gums (configure gums)
echo '2....configuring new gums server'
echo "GRANT ALL ON GUMS_1_3.* TO 'gums'@'localhost' IDENTIFIED BY '$GUMSPASSWD';" | mysql -u root mysql

#get gums.config from old rpm
echo '3....copying gums.config from old rpm to new rpm'
cp -f -p $GUMSCONFIGRPM $GUMSCONFIGRPM.original
cp -f $GUMSCONFIGFROMRPM $GUMSCONFIGRPM
chown tomcat:tomcat $GUMSCONFIGRPM
chmod 600 $GUMSCONFIGRPM

#set add DN admin for gums
echo '4....adding gums DN admin'
cat /usr/lib/gums/sql/addAdmin.mysql | sed -e "s%@ADMINDN@%$ADMINID1%g" | mysql -u gums --password=$GUMSPASSWD

echo "it is recomended to run /usr/bin/mysql_secure_installation"

</file>

<file name="/root/ConfigureGumsFreshInstall.sh" perms="0700" >
#!/bin/bash

#input parameters
GUMSPASSWD=myrocksgums
ADMINID1='&OSG_GUMSDNADMIN;'

service mysqld start
echo '1....configuring a fresh install gums server'
/usr/bin/gums-setup-mysql-database --user gums --host localhost:3306 --password $GUMSPASSWD

#set add DN admin for gums
echo '2....adding gums DN admin'
#gums-add-mysql-admin '/MY/DN'
cat /usr/lib/gums/sql/addAdmin.mysql | sed -e "s%@ADMINDN@%$ADMINID1%g" | mysql -u gums --password=$GUMSPASSWD

echo "it is recomended to run /usr/bin/mysql_secure_installation"
</file>

</post>

</kickstart> 

